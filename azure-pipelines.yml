trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: dynatrace-vars

steps:
- bash: |
    echo "üîç Probando conexi√≥n con Dynatrace en $DYNATRACE_URL"
    CODE=$(curl -s -o /dev/null -w "%{http_code}" \
      -H "Authorization: Api-Token $DYNATRACE_API_TOKEN" \
      "$DYNATRACE_URL/api/v2/metrics")
    echo "HTTP CODE: $CODE"
    if [ "$CODE" -ne 200 ]; then
      echo "‚ùå Fall√≥ la conexi√≥n (esperado 200)"
      exit 1
    fi
    echo "‚úÖ Conexi√≥n OK"
  displayName: 'Test conexi√≥n Dynatrace'
  env:
    DYNATRACE_API_TOKEN: $(DYNATRACE_API_TOKEN)
    DYNATRACE_URL: $(DYNATRACE_URL)

- bash: |
    echo "üöÄ Enviando evento de prueba..."
    NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    curl -s -X POST "$(DYNATRACE_URL)/api/v2/logs/ingest" \
      -H "Authorization: Api-Token $DYNATRACE_API_TOKEN" \
      -H "Content-Type: application/json" \
      -d "{
            \"title\": \"Azure DevOps POC conectado\",
            \"event.type\": \"CUSTOM_ANNOTATION\",
            \"source\": \"AzureDevOps\",
            \"timestamp\": \"$NOW\",
            \"properties\": {
              \"service\": \"$(SERVICE_NAME)\",
              \"env\": \"$(ENV_NAME)\",
              \"pipelineId\": \"$(System.DefinitionId)\",
              \"runId\": \"$(Build.BuildId)\"
            }
          }"
    echo ""
    echo "‚úÖ Evento enviado. Revisa Dynatrace ‚Üí Logs & Events (fetch events)."
  displayName: 'Enviar evento de prueba'
  condition: succeeded()
  env:
    DYNATRACE_API_TOKEN: $(DYNATRACE_API_TOKEN)
    DYNATRACE_URL: $(DYNATRACE_URL)
    SERVICE_NAME: $(SERVICE_NAME)
    ENV_NAME: $(ENV_NAME)
- bash: |
    echo "üì¶ Enviando log de build y release a Dynatrace..."
    STATUS=$(if [ "$(Agent.JobStatus)" == "Succeeded" ]; then echo "SUCCESS"; else echo "FAILED"; fi)
    NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    curl -s -X POST "$(DYNATRACE_URL)/api/v2/logs/ingest" \
      -H "Authorization: Api-Token $DYNATRACE_API_TOKEN" \
      -H "Content-Type: application/json; charset=utf-8" \
      -d "[
        {
          \"timestamp\": \"$NOW\",
          \"title\": \"Azure DevOps Build $STATUS\",
          \"content\": \"Pipeline $(Build.DefinitionName) ejecutado con estado $STATUS\",
          \"log.source\": \"AzureDevOps\",
          \"service.name\": \"$(SERVICE_NAME)\",
          \"env\": \"$(ENV_NAME)\",
          \"pipeline.id\": \"$(System.DefinitionId)\",
          \"run.id\": \"$(Build.BuildId)\",
          \"status\": \"$STATUS\"
        }
      ]"
  displayName: "Enviar log de build/release a Dynatrace"
  condition: always()
